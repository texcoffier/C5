<head>
    <meta charset="utf-8">
    <title>C5 : C5 is Compiler Course Class in the Cloud</title>
    <style>
        BODY {
            --body: 50em;
            max-width: var(--body);
            font-family: sans-serif;
            background: #F8F8F8;
            line-height: 1.3em;
        }

        H1 {
            font-size: 150%;
            border: 1px solid #000;
            padding: 0.2em;
        }

        H2 {
            font-size: 120%;
            background: #FFF;
            border-bottom: 1px solid #000;
        }

        H3 {
            font-size: 100%;
        }

        TABLE {
            border-collapse: collapse;
            border-spacing: 0px;
        }

        TABLE TD {
            border: 1px solid #888;
            vertical-align: top;
        }

        .NI {
            background: #FEE;
            border: 1px solid #F00;
        }

        .NI:after {
            content: 'pas encore impl√©ment√©';
            font-size: 50%;
            display: inline-block;
            width: 6em;
            background: #FCC;
            line-height: 1em;
            text-align: center;
        }

        TT,
        PRE {
            background: #FFE;
            border: 1px solid #880;
            font-family: monospace, monospace;
            font-size: 90%;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <h1><img src="c5.svg" style="height:1em"> : C5 is Compiler Course Class in the Cloud</h1>
    <p>
        Pourquoi utiliser C5 ?
    </p>
    <h2>Emp√™cher toute tricherie lors des examens sur machine.</h2>
    <ul>
        <li> Tout est fait dans une unique page web facile √† surveiller visuellement :
            <ul>
                <li> Sujet de l'examen, √©ventuellement diff√©rent pour chaque √©tudiant.</li>
                <li> Aide pour les √©tudiants bloqu√©s.</li>
                <li> √âditeur de code pour r√©pondre.</li>
                <li> R√©sultat de compilation.</li>
                <li> R√©sultat de l'ex√©cution.</li>
            </ul>
        </li>
        <li> Le copier/copier de sources ext√©rieures est impossible.</li>
        <li> Toutes les actions clavier/souris sont m√©moris√©es.</li>
    </ul>
    <h2>Avoir un environnement TP imm√©diatement fonctionnel.</h2>
    <p>
        En effet :
    </p>
    <ul>
        <li> Rien besoin d'installer pour les √©tudiants.</li>
        <li> Pas besoin d'apprendre √† utiliser un logiciel.</li>
        <li> Coloration syntaxique.</li>
        <li> Recompilation et ex√©cution temps-r√©el.</li>
        <li> Indices pour guider l'√©tudiant vers la solution.</li>
        <li> Ne n√©cessite pas de serveur pour fonctionner (sauf pour la compilation distante) :
            <ul>
                <li> Pas de panne possible.</li>
                <li> Pas de surcharge du serveur.</li>
                <li> Utilisation sans connexion Internet possible.</li>
            </ul>
        </li>
    </ul>
    <h2>Comment d√©finir un sujet</h2>
    <p>
        L'ensemble de l'environnement est programm√© en Python.
    </p>
    <p>
        Chaque sujet contient un ensemble de questions s'encha√Ænant successivement.
    </p>
    <ul>
        <li> Le sujet est dans un fichier avec comme nom¬†:<br>
            <tt>course_{js|python|cpp|remote}_<b>nom_sujet</b>.py</tt><br>
            par exemple <tt>course_js_<b>example</b>.py</tt>
        </li>
        <li> Il est compil√© en tapant¬†:<br>
            <tt>make course_js_<b>example.js</b></tt></li>
        <li> Il est utilisable avec l'URL¬†:<br>
            <tt>‚Ä¶/=course_js_<b>example.js</b></tt></li>
    </ul>
    <p>
        Pour chaque question il y a une classe
        dont les m√©thodes d√©finissent la question.
        Voici les m√©thodes possibles dans l'ordre d'appel¬†:
    </p>
    <ul>
        <li> <tt>default_answer(self)</tt> qui retourne la valeur initiale de l'√©diteur.</li>
        <li> <tt>question(self)</tt> qui retourne la question au format HTML.
            C'est ce qui est affich√© en haut √† gauche.
            Cette m√©thode est appel√©e chaque fois que l'√©tudiant arrive sur la question.
            Si la question est al√©atoire, on peut conserver dans l'instance
            de la question l'al√©a choisi ou bien en choisir un nouveau √† chaque fois.
        </li>
        <li> <tt>tester(self)</tt> qui affiche les indices
            et d√©cide quand faire passer √† la question suivante.
            C'est ce qui est affich√© en bas √† gauche.
        </li>
    </ul>
    </p>
    <pre>class Q1(Question):
    """Question 1"""
    def question(self):
        return "&lt;p&gt;Vous devez faire afficher ¬´Bonjour¬ª&lt;/p&gt;"
    def tester(self):
        self.display('&lt;p&gt;Dans votre code source on devrait trouver¬†:&lt;/p&gt;')
        self.check(self.worker.source, [
            ['print'  , 'Le nom de la fonction ¬´print¬ª pour afficher la valeur'],
            ['Bonjour', 'Le texte ¬´Bonjour¬ª que vous devez afficher'],
                ])
        if self.worker.execution_result == 'Bonjour\n':
            self.next_question()
    def default_answer(self):
        return "# Tapez votre programme ici :\n"</pre>
    <p>
        Un sujet complet est une liste de question g√©r√©es
        par un unique compilateur.
        Par exemple¬†:
    </p>
    <pre>Compile_Python([Q0(), Q1(), Q2(), Q3(), QEnd()])</pre>

    <h3>Attributs</h3>
    <ul>
        <li> <tt>self.worker.execution_result</tt> r√©sultat de l'ex√©cution
            une fois toutes les lectures claviers faites</li>
        <li> <tt>self.worker.source</tt> la r√©ponse de l'√©tudiant</li>
        <li> <tt>self.all_tests_are_fine</tt> vrai au d√©part puis mis √† jour automatiquement
            par les fonctions utilitaires.
        </li>
        <li> <tt>self.worker.current_question_max = 42</tt>
            donne le droit d'acc√®s aux 42 premi√®res questions.
        </li>
    </ul>

    <h3>Fonctions utilitaires</h3>
    <ul>
        <li> <tt>millisec()</tt> depuis le 1 janvier 1970</li>
        <li> <tt>self.display(html)</tt> affiche dans la zone de test</li>
        <li> <tt>self.worker.escape(text)</tt> √©chappe les balises HTML</li>
        <li> <tt>self.next_question()</tt> passage √† la question suivante</li>
        <li> <tt>self.message(bool, message)</tt>
            affiche le message vert si <tt>bool</tt> est vrai, sinon rouge.</li>
        <li> <tt>self.check(text, [ [re, message], ...])</tt>
            affiche les messages vert/rouge en fonction de la pr√©sence
            de <tt>re</tt> dans <tt>text</tt>
        </li>
        <li> <pre>self.set_options(
    {
        'language': 'javascript',
        'forbiden': "Coller du texte copi√© venant d'ailleurs n'est pas autoris√©.",
        # Affichage d√©pend du navigateur
        # Mettre une chaine vide pour d√©sactiver la confirmation (pendant le d√©bugage)
        'close': "Voulez-vous vraiment quitter cette page ?",
        'question_title': 'Question',
        'tester_title': 'Les buts que vous devez atteindre',
        'compiler_title': 'Compilation',
        'compiler_title_toggle': 'D√©sactiv√©e (F9)',
        'compiler_title_button': 'Maintenant ! (F9)',
        'executor_title': 'Ex√©cution',
        'good': ["Bravo !", "Excellent !", "Super !", "G√©nial !", "Vous √™tes trop fort !"],
        'icon_reset': 'üóë',
        'icon_save': 'üì©',
        'reset_confirm': 'Vous voulez vraiment revenir √† la version de d√©part ?',
        'time_running': 'Fini dans',
        'time_done': "Fini depuis",
        'time_seconds': " secondes",
        'time_days': " jours",
        'time_d': " j ",
        'time_m': " m ",
        'time_h': " h ",
        'allow_copy_paste': False,
        'display_reset': True,
        'automatic_compilation': True, # Recompile d√®s que c'est possible
        'positions' : { # [X, Largeur, Y, Hauteur, Couleur] en pourcentage √©cran
            'question': [1, 29, 0, 30, '#EFE'],
            'tester': [1, 29, 30, 70, '#EFE'],
            'editor': [30, 40, 0, 100, '#FFF'],
            'compiler': [70, 30, 0, 30, '#EEF'],
            'executor': [70, 30, 30, 70, '#EEF'],
            'time': [80, 20, 98, 2, '#0000'],
            'index': [0, 1, 0, 100, '#0000'],
            'save_button': [66, 2, 0, 2, '#0000'],
            'reset_button': [68, 2, 0, 2, '#0000'],
            },
        # For compile_remote. The values must be allowed by the server.
        'compiler': 'g++', # or 'gcc'
        'compile_options': ['-Wall'], # -pedantic
        'ld_options': [],
        'allowed': [], # system call allowed 'brk'

    })</pre>
        Il faut mettre seulement les options qui changent.
        Les options restent les m√™mes tant qu'elles ne sont pas modifi√©es.
        La disposition de l'√©cran peut changer d'une question √† l'autre.
    </li>
    </ul>



    <h2>Langages support√©s</h2>
    <p>
        Il est n√©cessaire d'avoir un compilateur du langage √©crit en JavaScript¬†:
    </p>
    <ul>
        <li> JavaScript: <tt>Compile_JS</tt></li>
        <li> Python: <tt>Compile_Python</tt></li>
        <li> C++: <tt>Compile_CCP</tt>)
            ATTENTION : pas de classe, de structure ni de passage par r√©f√©rence.
        </li>
        <li> C++: <tt>Compile_remote</tt> envoi des requ√™tes √†
            <tt>compile_server.py</tt> pour compiler avec <tt>g++</tt>
            et ex√©cuter. Supporte <tt>cin</tt> mais pas le graphique.
            Tous les appels syst√®mes sont interdits (sauf <tt>fstat</tt>, <tt>write</tt>, <tt>read, </tt><tt>lseek</tt>, <tt>exit_group</tt>),
            donc pas de probl√®me de s√©curit√©.
            Temps et espace limit√© pour la compilation et l'ex√©cution.</li>
    </ul>

    <h2>D√©voloppements possibles</h2>
    <p>
        De nombreuses possibilit√©s pour le futur :
    </p>
    <ul>
        <li> Fonctions graphiques.</li>
        <li> Conseils pour utiliser le clavier plut√¥t que la souris.</li>
    </ul>

    <h2>Installer C5</h2>
    <p>
        Lancez ces commandes (Ubuntu) :
    </p>
    <pre>apt update
apt install python3-websockets python3-aiohttp curl npm # nginx certbot
git clone https://github.com/texcoffier/C5.git
cd C5
make</pre>
    <p>
        Si tout s'est bien pass√©, une page web s'ouvre sur une copie
        de cette page qui est sur votre machine.
        L'interface d'administration est <tt>.../adm_home</tt>
    </p>
    <h3>Configuration NGINX</h3>
    <p>
        Il faut remplacer /WebSocket/, 4201, 4202 par les bonnes valeurs.
    </p>
    <pre>
server {
    listen 443 ssl;
    server_name c5.univ-lyon1.fr;
    ssl_certificate /etc/letsencrypt/live/c5.univ-lyon1.fr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/c5.univ-lyon1.fr/privkey.pem; # managed by Certbot
    location ~ /WebSocket/ {
        rewrite ^/WebSocket/(.*) /$1 break;
        proxy_pass http://127.0.0.1:4202;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection Upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    location ~ {
        proxy_pass http://127.0.0.1:4201;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
  }
            </pre>
    <h2>TODO</h2>
    <p>
        Fonctionnalit√©s manquantes:
    </p>
    <ul>
        <li> Sauvegarde quand la page est ferm√©e. </li>
        <li> M√©nage ticket CAS. </li>
        <li> M√©nage fichiers log. </li>
    </ul>
</body>